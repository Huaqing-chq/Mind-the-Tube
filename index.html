<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind the Tube - 伦敦地铁运营实况</title>
    <!-- 引入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 引入 Inter 字体 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        :root {
            --font-family-sans: 'Inter', sans-serif;
            --tfl-red: #c8003a;
        }

        body {
            font-family: var(--font-family-sans);
            /* 确保 body 占据整个视口高度 */
            min-height: 100vh;
        }

        /* --- 核心布局修复: 确保列表不被挤压 --- */
        #app-container {
            /* 设置最大宽度并居中 */
            margin-left: auto;
            margin-right: auto;
            width: 100%;
            /* 关键修复: 启用全高列布局 */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        #status-container {
            /* 关键修复: 占据所有剩余垂直空间，并允许内部滚动 */
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 1rem; /* 确保底部与页脚之间有间距 */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        /* 隐藏 WebKit 浏览器的滚动条 */
        #status-container::-webkit-scrollbar {
            display: none;
        }
        /* --- 核心布局修复结束 --- */

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--tfl-red);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dark Mode Spinner */
        .dark .spinner {
            border-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--tfl-red);
        }

        /* Line Color Mapping (TfL Official Colors - 用于卡片左侧边框) */
        .line-card {
            border-left-width: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.3s ease-in-out;
        }
        .line-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Line Colors (TfL specific) */
        .bakerloo { border-color: #B36305; }
        .central { border-color: #E32017; }
        .circle { border-color: #FFD300; }
        .district { border-color: #00782A; }
        .hammersmith-city { border-color: #F3A9A2; }
        .jubilee { border-color: #A0A5A9; }
        .metropolitan { border-color: #9B0056; }
        .northern { border-color: #000000; }
        .piccadilly { border-color: #003688; }
        .victoria { border-color: #0098D4; }
        .waterloo-city { border-color: #99D1C9; }
        .elizabeth { border-color: #6950a1; }
        .london-overground { border-color: #EE7D3A; }

        /* Status Backgrounds (用于状态芯片) */
        .status-good { background-color: #d1fae5; color: #065f46; } /* Light Green */
        .status-minor { background-color: #fef3c7; color: #92400e; } /* Light Yellow/Orange */
        .status-severe, .status-partclosure, .status-closure { background-color: #fecaca; color: #991b1b; } /* Light Red */
        .status-chip {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75rem; /* text-xs */
            white-space: nowrap;
        }

        /* Dark Mode Adjustments */
        .dark {
            background-color: #111827; /* Tailwind gray-900 */
        }
        .dark .line-card {
            background-color: #1f2937; /* Tailwind gray-800 !important;
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.05);
        }
        .dark .status-good { background-color: #047857; color: #ccfbf1; }
        .dark .status-minor { background-color: #ca8a04; color: #fef9c3; }
        .dark .status-severe, .dark .status-partclosure, .dark .status-closure { background-color: #b91c1c; color: #fecaca; }
        .dark #header {
            border-color: #dc2626; /* red-600 */
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">

    <!-- App Container: Full height flexible column -->
    <div id="app-container" class="max-w-xl p-4 sm:p-6">

        <!-- Header (Fixed Height) -->
        <header id="header" class="flex-shrink-0 mb-6 pb-2 border-b-4 border-red-700 dark:border-red-500 transition-colors duration-300">
            <h1 class="text-3xl font-extrabold text-gray-900 dark:text-white">Mind the Tube</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400">Live London Underground Status</p>
        </header>

        <!-- Status Container (Flexible Height - Fixes Squeezing Issue) -->
        <!-- 此容器使用 flex-grow 占据所有剩余空间，并支持独立滚动 -->
        <main id="status-container" class="space-y-4">
            <!-- Loading and status cards will be injected here by JavaScript -->
            <div id="loading-indicator" class="text-center p-8">
                <div class="spinner"></div>
                <p class="text-gray-500 dark:text-gray-400 mt-3">Fetching live status from TfL...</p>
            </div>
            <div id="error-message" class="hidden text-red-600 dark:text-red-400 bg-red-100 dark:bg-red-900 p-4 rounded-lg shadow-md border border-red-300">
                <p class="font-bold mb-1">❌ 获取失败</p>
                <p id="error-text">Could not load real-time data. Please check your network connection or try again later.</p>
            </div>
        </main>

        <!-- Footer (Fixed Height) -->
        <footer id="footer" class="flex-shrink-0 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 text-center text-xs text-gray-500 dark:text-gray-400">
            <p>Data provided by Transport for London (TfL) Open Data. (Real Data via TfL API)</p>
            <p>Last Updated: <span id="last-updated">--:--</span></p>
        </footer>
    </div>

    <!-- Station Detail Modal (Copied from previous response for completeness) -->
    <div id="station-detail-modal" class="hidden fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center">
        <div id="modal-content" class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg mx-4 p-6 transition-transform transition-opacity">
            <div class="flex justify-between items-center mb-6 border-b pb-3 border-gray-200 dark:border-gray-700">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800 dark:text-white">站点状态</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div id="station-list-container" class="max-h-96 overflow-y-auto pr-2">
                <div class="p-4 text-center text-gray-500 font-medium dark:text-gray-400">正在获取数据...</div>
            </div>

            <div class="mt-6 text-center">
                <button onclick="closeModal()" class="w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                    返回
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Configuration ---
        const API_KEY = '4bcc8c57347e4f8494fa94351900d78b';
        // 注意：TfL API 通常需要 app_id 和 app_key。我们假设此密钥作为 app_key 使用。
        const BASE_API_URL = 'https://api.tfl.gov.uk/Line/Mode/tube/Status';
        const REFRESH_INTERVAL = 30000; // 30 seconds

        // 线路 ID 到 CSS 类的映射 (用于边框颜色)
        const LINE_ID_MAP = {
            'bakerloo': 'bakerloo', 'central': 'central', 'circle': 'circle',
            'district': 'district', 'hammersmith-city': 'hammersmith-city', 'jubilee': 'jubilee',
            'metropolitan': 'metropolitan', 'northern': 'northern', 'piccadilly': 'piccadilly',
            'victoria': 'victoria', 'waterloo-city': 'waterloo-city', 'elizabeth': 'elizabeth',
            'london-overground': 'london-overground'
        };

        // --- DOM Elements ---
        const statusContainer = document.getElementById('status-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const lastUpdatedSpan = document.getElementById('last-updated');

        // Modal Elements
        const modal = document.getElementById('station-detail-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const stationListContainer = document.getElementById('station-list-container');
        let isModalOpen = false;

        // --- Mock Data (用于 API 失败时的回退/Fallback) ---
        const mockLineStatus = [
            { id: 'victoria', name: 'Victoria', lineStatuses: [{ statusSeverityDescription: 'Good Service', statusSeverity: 10, reason: null }] },
            { id: 'central', name: 'Central', lineStatuses: [{ statusSeverityDescription: 'Minor Delays', statusSeverity: 9, reason: '信号故障导致轻微延误' }] },
            { id: 'northern', name: 'Northern', lineStatuses: [{ statusSeverityDescription: 'Part Closure', statusSeverity: 6, reason: 'High Barnet to Finchley Central - Service closed' }] },
            { id: 'jubilee', name: 'Jubilee', lineStatuses: [{ statusSeverityDescription: 'Good Service', statusSeverity: 10, reason: null }] },
            { id: 'piccadilly', name: 'Piccadilly', lineStatuses: [{ statusSeverityDescription: 'Severe Delays', statusSeverity: 3, reason: 'Staff sickness causing severe disruption' }] },
        ];

        // Mock Disrupted Station IDs (站点详情功能仍使用模拟数据，因为 API 密钥仅支持线路状态)
        const disruptedStationIds = new Set([
            '940GZZLUBBN', // Bank
            '940GZZLUOXC', // Oxford Circus (on Central & Victoria)
            '940GZZLUWLO', // Waterloo (on Northern & Jubilee)
            '940GZZLUAMS', // Amersham (on Metropolitan)
        ]);

        // Mock StopPoints (站点详情功能仍使用模拟数据)
        const mockStopPoints = {
            'victoria': [
                { id: '940GZZLUVIC', commonName: 'Victoria' },
                { id: '940GZZLUOXC', commonName: 'Oxford Circus' }, // Disrupted
                { id: '940GZZLUEUS', commonName: 'Euston' },
                { id: '940GZZLUWLO', commonName: 'Waterloo' }, // Disrupted
            ],
            'central': [
                { id: '940GZZLUSWC', commonName: 'South Woodford' },
                { id: '940GZZLUOXC', commonName: 'Oxford Circus' }, // Disrupted
                { id: '940GZZLUBNK', commonName: 'Bank' }, // Disrupted
                { id: '940GZZLULIV', commonName: 'Liverpool Street' },
            ],
            // Add more mock data here for other lines if needed
        };
        // --- End Mock Data ---

        /**
         * 获取线路状态对应的 CSS 状态类
         * @param {number} severity 状态严重性等级 (1-10)
         * @returns {string} Tailwind CSS 类
         */
        function getStatusClass(severity, description) {
            const desc = description.toLowerCase();
            if (desc.includes('closure') || desc.includes('severe')) {
                return 'status-severe';
            }
            if (severity === 10 || desc.includes('good')) {
                return 'status-good';
            }
            if (severity >= 7) {
                return 'status-minor';
            }
            return 'status-severe'; // 默认严重延迟或关闭
        }

        /**
         * 渲染初始的线路状态卡片
         * @param {Array} data 线路状态数据
         */
        function renderLineCards(data) {
            // 清空旧内容
            statusContainer.innerHTML = ''; 

            data.forEach(line => {
                // TfL API 数据的结构是 lineStatuses 数组，取第一个状态
                const status = line.lineStatuses && line.lineStatuses.length > 0 ? line.lineStatuses[0] : { statusSeverityDescription: 'Unknown Status', statusSeverity: 0, reason: null };
                
                const lineClass = LINE_ID_MAP[line.id] || 'northern'; // Default to Northern/Black if not found
                const statusClass = getStatusClass(status.statusSeverity, status.statusSeverityDescription);
                
                const cardHtml = `
                    <div class="line-card p-4 bg-white dark:bg-gray-800 text-gray-900 dark:text-white transition-colors duration-300 shadow-lg cursor-pointer ${lineClass}"
                         data-line-id="${line.id}"
                         onclick="fetchStationStatus('${line.id}', '${line.name}')">
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-bold">${line.name} Line</h3>
                            <span class="status-chip ${statusClass}">
                                ${status.statusSeverityDescription}
                            </span>
                        </div>
                        ${status.reason ? `<p class="text-sm text-gray-600 dark:text-gray-400 mt-2">${status.reason}</p>` : ''}
                    </div>
                `;
                statusContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
            
            // 更新最后刷新时间
            lastUpdatedSpan.textContent = new Date().toLocaleTimeString();
        }


        /**
         * 获取线路状态 (使用 TfL API 实时获取数据)
         */
        async function fetchLineStatuses() {
   // 确保加载指示器可见
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            statusContainer.innerHTML = ''; // 清空旧内容

            try {
                const fetchUrl = `${BASE_API_URL}?app_key=${API_KEY}`;
                
                const response = await fetch(fetchUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // TfL API 返回一个线路数组，直接传递给渲染函数
                renderLineCards(data); 

            } catch (error) {
                console.error("加载线路状态失败:", error);
                errorText.textContent = `无法加载实时数据。错误信息: ${error.message}. 正在使用模拟数据作为回退。`;
                errorMessage.classList.remove('hidden');
                
                // 回退到模拟数据
                renderLineCards(mockLineStatus); 
            } finally {
                // 无论成功还是失败，都隐藏加载指示器
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * 处理线路卡片点击事件：获取站点列表和中断信息，并进行对比。
         * 注意：此功能目前仍使用模拟数据 (mockStopPoints/disruptedStationIds)，因为未提供查询站点信息的 API 密钥。
         * @param {string} lineId 线路ID (e.g., 'victoria')
         * @param {string} lineName 线路名称 (e.g., 'Victoria')
         */
        async function fetchStationStatus(lineId, lineName) {
            modalTitle.innerHTML = `${lineName} 站点状态 <span class="text-sm font-normal text-gray-500 dark:text-gray-400">(正在加载...)</span>`;
            stationListContainer.innerHTML = `<div class="p-4 text-center text-gray-500 font-medium dark:text-gray-400">正在获取数据...</div>`;
            openModal();

            try {
                // 模拟 API 延迟和数据获取
                await new Promise(resolve => setTimeout(resolve, 800)); 

                const lineStopPoints = mockStopPoints[lineId] || [];
                
                // 交叉对比逻辑：检查该线路上是否有站点ID在全局中断列表中
                const stationStatuses = lineStopPoints.map(station => {
                    const isDisrupted = disruptedStationIds.has(station.id);
                    let statusText = '服务良好 (Good Service)';
                    let statusColor = 'text-green-600 dark:text-green-400';

                    if (isDisrupted) {
                        statusText = '服务中断 (Service Disruption)';
                        statusColor = 'text-red-600 dark:text-red-400 font-bold';
                    }

                    return {
                        name: station.commonName,
                        status: statusText,
                        color: statusColor
                    };
                }).sort((a, b) => a.name.localeCompare(b.name)); // 按站名排序

                renderStationDetails(lineName, stationStatuses);

            } catch (error) {
                console.error(`获取 ${lineName} 站点状态失败:`, error);
                modalTitle.innerHTML = `${lineName} 站点状态`;
                stationListContainer.innerHTML = `<div class="p-4 text-center text-red-500 font-medium dark:text-red-400">加载站点详情失败。</div>`;
            }
        }

        /**
         * 渲染站点状态详情列表
         */
        function renderStationDetails(lineName, stations) {
            modalTitle.textContent = `${lineName} 站点状态`;
            
            if (stations.length === 0) {
                stationListContainer.innerHTML = `<div class="p-4 text-center text-gray-500 dark:text-gray-400">该线路暂无站点信息（模拟数据）。</div>`;
                return;
            }

            let listHtml = `<ul class="space-y-3">`;
            stations.forEach(station => {
                listHtml += `
                    <li class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg border border-gray-200 dark:border-gray-600">
                        <span class="text-gray-700 dark:text-gray-200 font-medium">${station.name}</span>
                        <span class="${station.color} text-sm font-semibold">${station.status}</span>
                    </li>
                `;
            });
            listHtml += `</ul>`;
            stationListContainer.innerHTML = listHtml;
        }

        /**
         * 显示详情模态框
         */
        function openModal() {
            isModalOpen = true;
            modal.classList.remove('hidden');
        }

        /**
         * 隐藏详情模态框
         */
        function closeModal() {
            isModalOpen = false;
            modal.classList.add('hidden');
        }

        // --- 初始化加载 ---
        window.onload = () => {
            fetchLineStatuses();
            // 设置定时刷新（如果使用真实 API）
            // setInterval(fetchLineStatuses, REFRESH_INTERVAL); 
        };

        // 绑定 ESC 键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isModalOpen) {
                closeModal();
            }
        });
    </script>
</body>
</html>