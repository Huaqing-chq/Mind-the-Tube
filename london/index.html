<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mind the Tube â€” å®æ—¶ä¼¦æ•¦åœ°é“çŠ¶æ€</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    /* æ ¸å¿ƒé¢œè‰² */
    :root{
      --tfl-blue: #0019A8; /* TfL Standard Blue */
      --tfl-red: #e60028; /* TfL Standard Red */
      --bg: #f3f4f6;
      --card: #ffffff;
      --muted: #6b7280;
    }

    /* åŸºç¡€å¸ƒå±€ */
    html,body{
      height:100%;
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: #111827;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* å®¹å™¨ï¼šæœ€å¤§å®½åº¦å¹¶å‚ç›´ä¼¸å±• */
    #app-container{
      max-width: 960px;
      margin: 0 auto;
      padding: 18px;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      box-sizing:border-box;
    }

    /* Header */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding-bottom:12px;
      border-bottom:4px solid var(--tfl-red);
    }

    .brand {
      display:flex;
      align-items:center;
      gap:12px;
    }

    .title {
      font-weight:800;
      font-size:20px;
      letter-spacing:0.2px;
    }

    .subtitle {
      font-size:13px;
      color:var(--muted);
      margin-top:2px;
    }

    /* Roundel containerï¼ˆå³ä¾§ï¼‰ */
    .roundel-wrap{
      display:flex;
      align-items:center;
      gap:12px;
    }
    
    .roundel-wrap a {
      /* ç¡®ä¿é“¾æ¥å®Œå…¨è¦†ç›– roundel åŒºåŸŸ */
      display: block; 
      cursor: pointer;
    }

    /* Roundel SVG */
    .roundel {
      width:64px;
      height:64px;
      position:relative;
      flex-shrink:0;
    }

    /* å†…éƒ¨è“è‰²æ¡çš„æ–‡å­—è½®æ¢ */
    .roundel .band {
      position:absolute;
      left:0;
      right:0;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      height:22px;
      overflow:hidden;
    }

    .roundel .band .word {
      display:block;
      height:22px;
      line-height:22px;
      font-weight:500;
      color:white;
      padding:0 10px;
      white-space:nowrap;
      animation: slideWords 12s linear infinite;
    }

    /* æ¯ä¸ª word å‘ä¸Šæ»šåŠ¨ï¼Œå…³é”®å¸§å¤„ç†ä¸º 6 ä¸ªè¯çš„å¾ªç¯ï¼ˆç­‰åˆ†ï¼‰ */
    @keyframes slideWords {
      0% { transform: translateY(0); }
      16.66% { transform: translateY(-22px); }
      33.33% { transform: translateY(-44px); }
      50% { transform: translateY(-66px); }
      66.66% { transform: translateY(-88px); }
      83.33% { transform: translateY(-110px); }
      100% { transform: translateY(0); }
    }

    /* ä¸»ä½“ï¼ˆçŠ¶æ€åˆ—è¡¨åŒºåŸŸï¼‰ */
    main {
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
      padding-top:18px;
      padding-bottom:18px;
      overflow:visible;
    }

    #status-container{
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
      padding-right:6px;
    }

    /* å¡ç‰‡æ ·å¼ */
    .line-card{
      display:flex;
      flex-direction:column;
      background:var(--card);
      border-radius:10px;
      padding:12px;
      box-shadow:0 6px 18px rgba(15,23,42,0.06);
      border-left:8px solid #333;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .line-card:hover{ transform: translateY(-3px); box-shadow:0 12px 30px rgba(15,23,42,0.08); }

    .line-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .line-title{
      font-weight:700;
      font-size:16px;
    }

    .status-chip{
      font-weight:700;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .status-good{ background:#d1fae5; color:#065f46; }
    .status-minor{ background:#fff7ed; color:#92400e; }
    .status-severe{ background:#fee2e2; color:#991b1b; }

    .line-reason{
      margin-top:8px;
      color:#374151;
      font-size:13px;
    }

    /* ç«™ç‚¹å±•å¼€é¢æ¿ */
    .stations-panel{
      margin-top:10px;
      border-radius:8px;
      overflow:hidden;
      border:1px dashed rgba(0,0,0,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(250,250,250,0.96));
      padding:8px;
    }

    .station-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px;
      border-bottom:1px solid rgba(15,23,42,0.03);
    }
    .station-row:last-child{ border-bottom:0; }

    .station-name{ font-weight:600; color:#0f172a; }
    .station-next{ font-size:13px; color:#374151; text-align:right; min-width:160px; }

    /* Footer */
    footer{
      margin-top:12px;
      padding-top:10px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }

    /* Loading / Error */
    .loading {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:18px;
      color:var(--muted);
    }

    .spinner {
      width:28px; height:28px;
      border-radius:50%;
      border:3px solid rgba(0,0,0,0.08);
      border-left-color:var(--tfl-red);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-box {
      background:#fef2f2;
      color:#991b1b;
      padding:10px;
      border-radius:8px;
      font-weight:600;
    }

    /* Responsive */
    @media (max-width:640px){
      .roundel { width:52px; height:52px; }
      .line-title{ font-size:15px; }
      .station-next{ min-width:120px; font-size:12px; }
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b1220;
        --card: #0f1724;
        --muted: #9ca3af;
      }
      body{ background: var(--bg); color:#e6eef8;}
      header{ border-bottom-color:var(--tfl-red);}
      .line-card{ background: linear-gradient(180deg,#0b1224,#0c1528); box-shadow: 0 6px 20px rgba(2,6,23,0.6);}
      .line-reason{ color:#cbd5e1;}
      .stations-panel{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03);}
    }

    /* TfL Line color utility classes (left border) */
    .border-Bakerloo { border-left-color: #B36305; }
    .border-Central { border-left-color: #E32017; }
    .border-Circle { border-left-color: #FFD300; }
    .border-District { border-left-color: #00782A; }
    .border-Hammersmith-and-City { border-left-color: #F3A9BB; }
    .border-Jubilee { border-left-color: #A0A5A9; }
    .border-Metropolitan { border-left-color: #9B0056; }
    .border-Northern { border-left-color: #000000; }
    .border-Piccadilly { border-left-color: #003688; }
    .border-Victoria { border-left-color: #0098D4; }
    .border-Waterloo-and-City { border-left-color: #99D1C7; }
    
    /* --- åŸå¸‚åˆ‡æ¢æ¨¡æ€çª—å£æ ·å¼ --- */

    /* é»˜è®¤éšè—ï¼Œè¦†ç›–æ•´ä¸ªå±å¹• */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    /* æ˜¾ç¤ºæ¨¡æ€çª—å£ */
    .modal-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    /* æ¨¡æ€çª—å£ä¸»ä½“ */
    .modal-content {
        background: var(--card);
        border-radius: 12px;
        padding: 20px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        transform: translateY(-50px);
        transition: transform 0.3s ease;
    }

    .modal-overlay.open .modal-content {
        transform: translateY(0);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 10px;
    }

    .modal-header h3 {
        font-size: 1.25rem;
        font-weight: 700;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--muted);
        padding: 0 10px;
        line-height: 1;
    }

    /* åŸå¸‚å¡ç‰‡æ ·å¼ */
    .modal-body {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .city-card {
        display: block;
        padding: 15px;
        border-radius: 8px;
        text-decoration: none;
        color: #1f2937;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .city-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .city-card h4 {
        font-weight: 700;
        margin-bottom: 4px;
    }

    .city-card p {
        font-size: 0.85rem;
        color: var(--muted);
    }

    /* æ ¹æ®åŸå¸‚æ·»åŠ é¢œè‰²ä¸»é¢˜ */
    .london-card {
        border: 1px solid var(--tfl-red);
        background: #fef2f2; /* æµ…çº¢èƒŒæ™¯ */
    }
    .dc-card {
        border: 1px solid var(--tfl-blue);
        background: #eff6ff; /* æµ…è“èƒŒæ™¯ */
    }

    /* æš—é»‘æ¨¡å¼é€‚é… (Modal) */
    @media (prefers-color-scheme: dark){
        .modal-content {
            background: var(--card);
        }
        .modal-header {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        .city-card {
            color: #e5e7eb;
        }
        .london-card {
            background: #451a03; /* æ·±çº¢æ£•è‰² */
            border-color: #7f1d1d;
        }
        .dc-card {
            background: #0f172a; /* æ·±è“è‰² */
            border-color: #1e3a8a;
        }
    }

  </style>
</head>
<body>
  <div id="app-container">
    <header>
      <div class="brand">
        <div>
          <div class="title">ä¼¦æ•¦åœ°é“ç›‘æµ‹</div>
          <div class="subtitle">å®æ—¶çŠ¶æ€ (TfL)</div>
        </div>
      </div>

      <div class="roundel-wrap" aria-hidden="true">
        <a href="#" onclick="openModal(); return false;" style="display: block; cursor: pointer;" title="åˆ‡æ¢åŸå¸‚"> 
            
            <div class="roundel" role="img" aria-label="TfL Roundel">
              <svg viewBox="0 0 100 100" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" style="display:block;">
                <circle cx="50" cy="50" r="36" stroke="#e60028" stroke-width="12" fill="white"></circle>
                <rect x="6" y="40" width="88" height="20" rx="3" ry="3" fill="#0019A8"></rect>
              </svg>
              <div class="band" style="left:6px; right:6px;">
                <div class="word">MIND THE GAP</div>
                <div class="word">TUBE</div>
                <div class="word">OVAL</div>
                <div class="word">BAKERLOO</div>
                <div class="word">VICTORIA</div>
                <div class="word">PICCADILLY</div>
              </div>
            </div>
        </a>
      </div>
    </header>

    <main>
      <section id="status-container" aria-live="polite">
        <div id="loading" class="loading">
          <div class="spinner" aria-hidden="true"></div>
          <div>æ­£åœ¨ä» TfL è·å–å®æ—¶çŠ¶æ€...</div>
        </div>

        <div id="error" class="error-box" style="display:none;"></div>

        </section>
    </main>

    <footer>
      å¼€æ”¾æ•°æ®æ¥æºäºä¼¦æ•¦äº¤é€šå±€ (TfL) Â· æˆ‘ä»¬ä¸ TfL æ²¡æœ‰ä»å±å…³ç³»
      <div style="margin-top:6px; font-size:12px; color:var(--muted)">ä¸Šæ¬¡æ›´æ–°æ—¶é—´: <span id="last-updated">--:--</span></div>
    </footer>
  </div>

  <div id="city-modal" class="modal-overlay" aria-modal="true" role="dialog" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3>é€‰æ‹©åŸå¸‚</h3>
        <button class="close-btn" aria-label="å…³é—­" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        
        <a href="index.html" class="city-card london-card">
          <h4>ğŸ‡¬ğŸ‡§ ä¼¦æ•¦ (London)</h4>
          <p>TfL åœ°é“å®æ—¶çŠ¶æ€</p>
        </a>
        
        <a href="../Washington/index.html" class="city-card dc-card">
          <h4>ğŸ‡ºğŸ‡¸ åç››é¡¿ç‰¹åŒº (DC)</h4>
          <p>WMATA åœ°é“å®æ—¶çŠ¶æ€</p>
        </a>
        
      </div>
    </div>
  </div>


<script>
/* -----------------------------------------------------
   TfL ä¼¦æ•¦åœ°é“å®æ—¶çŠ¶æ€ä¸»ç¨‹åº (åŒ…å«åŸå¸‚åˆ‡æ¢é€»è¾‘)
----------------------------------------------------- */

document.addEventListener("DOMContentLoaded", () => {

  const API_BASE = "https://api.tfl.gov.uk";
  
  const statusContainer = document.getElementById("status-container");
  const loadingBox = document.getElementById("loading");
  const errorBox = document.getElementById("error");
  const lastUpdated = document.getElementById("last-updated");
  
  // TfL ä»…åŒ…å«è¿™äº› Lines çš„çŠ¶æ€
  const LINE_IDS = [
    "Bakerloo", "Central", "Circle", "District", 
    "Hammersmith-and-City", "Jubilee", "Metropolitan", 
    "Northern", "Piccadilly", "Victoria", "Waterloo-and-City"
  ];

  // TfL çŠ¶æ€ç¿»è¯‘
  const STATUS_MAP_ZH = {
    "Good Service": "æ­£å¸¸æœåŠ¡",
    "Minor Delays": "è½»å¾®å»¶è¯¯",
    "Severe Delays": "ä¸¥é‡å»¶è¯¯",
    "Part Closure": "éƒ¨åˆ†å…³é—­",
    "Planned Closure": "è®¡åˆ’å…³é—­",
    "Suspended": "æš‚åœæœåŠ¡",
    "Reduced Service": "å‡å°‘æœåŠ¡",
    "Unknown": "æœªçŸ¥çŠ¶æ€",
    "API Failed": "API è¯·æ±‚å¤±è´¥",
    "Stations Failed": "ç«™ç‚¹æ•°æ®è·å–å¤±è´¥",
    "Data Unavailable": "æ— æ•°æ®",
    "Loading...": "åŠ è½½ä¸­..."
  };

  // ç¼“å­˜ï¼šç”¨äºå­˜å‚¨å„æ¡çº¿è·¯çš„ç«™ç‚¹åˆ—è¡¨
  let stationCache = {}; 
  // å…¨å±€å˜é‡ï¼šç”¨äºæ§åˆ¶ç«™ç‚¹åˆ°ç«™è¯·æ±‚çš„ä¸²è¡Œé˜Ÿåˆ—
  let arrivalQueue = Promise.resolve();

  /* ----------------------------------
    æ¨¡æ€çª—å£æ§åˆ¶å‡½æ•°
  -------------------------------------*/

  function openModal() {
    document.getElementById('city-modal').classList.add('open');
    document.getElementById('city-modal').setAttribute('aria-hidden', 'false');
  }

  function closeModal() {
    document.getElementById('city-modal').classList.remove('open');
    document.getElementById('city-modal').setAttribute('aria-hidden', 'true');
  }
  
  // å…è®¸ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
  document.addEventListener('click', (e) => {
      if (e.target.id === 'city-modal') {
          closeModal();
      }
  });


  /* ---------------------------
      TfL API è¯·æ±‚è¾…åŠ©å‡½æ•°
  --------------------------- */
  function fetchTfL(path) {
    // TfL API ä¸éœ€è¦ API Key
    const url = `${API_BASE}${path}`;
    return fetch(url, {
      method: 'GET',
      headers: { 'Accept': 'application/json' },
      cache: "no-cache"
    });
  }

  /* çŠ¶æ€ â†’ Chip é¢œè‰²åˆ†ç±» (ä½¿ç”¨è‹±æ–‡çŠ¶æ€åç§°) */
  function severityToClass(severity) {
    if (!severity) return "status-good";

    if (severity.includes("Good Service")) return "status-good";
    if (severity.includes("Minor")) return "status-minor";
    if (severity.includes("Severe") || severity.includes("Closure") || severity.includes("Suspended")) return "status-severe";

    return "status-minor";
  }

  /* ---------------------------
      1. ç¼“å­˜æ‰€æœ‰ç«™ç‚¹ä¿¡æ¯ (åªéœ€æ‰§è¡Œä¸€æ¬¡)
  --------------------------- */
  async function cacheStations() {
    try {
        // è·å–æ‰€æœ‰åœ°é“ç«™ç‚¹
        const res = await fetchTfL(`/StopPoint/Mode/tube/Disruption`);
        if (!res.ok) throw new Error(STATUS_MAP_ZH["Stations Failed"]);
        
        const data = await res.json();
        const allStopPoints = data.stopPoints;

        // æŒ‰ LineId åˆ†é…ç«™ç‚¹ï¼Œå¹¶æŒ‰åç§°æ’åº
        LINE_IDS.forEach(id => {
          stationCache[id] = allStopPoints
            .filter(s => s.lines.some(line => line.id === id.toLowerCase()))
            .sort((a, b) => a.commonName.localeCompare(b.commonName));
        });

    } catch (err) {
        console.error("Failed to cache stations:", err);
    }
  }

  /* ---------------------------
      2. ä¸»è¯·æ±‚ï¼šè·å–æ‰€æœ‰çº¿è·¯çŠ¶æ€
  --------------------------- */
  async function loadLineStatus() {
    try {
      loadingBox.style.display = "flex";
      errorBox.style.display = "none";
      
      // TfL çº¿è·¯çŠ¶æ€ API: /Line/Mode/tube/Status
      const res = await fetchTfL(`/Line/${LINE_IDS.join(',')}/Status`);
      if (!res.ok) throw new Error(STATUS_MAP_ZH["API Failed"]);
      
      const lines = await res.json();
      
      renderLineCards(lines);

      loadingBox.style.display = "none";
      lastUpdated.textContent = new Date().toLocaleTimeString();

    } catch (err) {
      loadingBox.style.display = "none";
      errorBox.textContent = STATUS_MAP_ZH["API Failed"] + ": " + err.message;
      errorBox.style.display = "block";
    }
  }

  /* ---------------------------
     æ¸²æŸ“çº¿è·¯å¡ç‰‡
  --------------------------- */
  function renderLineCards(lines) {
    const oldCards = statusContainer.querySelectorAll(".line-card");
    oldCards.forEach(x => x.remove());

    lines.forEach(line => {
      const id = line.id.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()).replace(/ /g, '-'); // æ ¼å¼åŒ–ä¸º CSS ç±»å
      
      // æ€»æ˜¯å–ç¬¬ä¸€ä¸ªçŠ¶æ€ï¼Œå¹¶ä¸”è½¬æ¢ä¸ºä¸­æ–‡
      const rawStatus = line.lineStatuses?.[0]?.statusSeverityDescription ?? "Unknown"; 
      const status = STATUS_MAP_ZH[rawStatus] || rawStatus;
      const reason = line.lineStatuses?.[0]?.reason ?? "";

      const severityClass = severityToClass(rawStatus); 
      
      const card = document.createElement("div");
      card.className = `line-card border-${id}`;
      // TfL çº¿è·¯åç§°é€šå¸¸æ˜¯å…¨å¤§å†™ï¼Œè¿™é‡Œæ˜¾ç¤ºä¸ºé¦–å­—æ¯å¤§å†™
      const displayName = id.replace(/-/g, ' '); 

      card.innerHTML = `
        <div class="line-head">
          <div class="line-title">
            ${displayName} Line
          </div>
          <div class="status-chip ${severityClass}">${status}</div>
        </div>
        ${reason ? `<div class="line-reason">${reason}</div>` : ""}
      `;

      card.addEventListener("click", () => toggleStations(id, card));

      statusContainer.appendChild(card);
    });
  }


  /* ---------------------------------------------------
     3. ç‚¹å‡»çº¿è·¯ â†’ è·å–ç«™å°åˆ°ç«™ä¿¡æ¯ (ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—)
  --------------------------------------------------- */
  async function toggleStations(lineId, cardEl) {
    const existing = cardEl.querySelector(".stations-panel");

    if (existing) {
      existing.remove();
      return;
    }

    // 1. åˆ›å»ºå¹¶æ˜¾ç¤ºåŠ è½½é¢æ¿
    const panel = document.createElement("div");
    panel.className = "stations-panel";
    
    panel.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <div>${STATUS_MAP_ZH["Loading..."]}</div>
      </div>
    `;
    cardEl.appendChild(panel);
    
    // 2. æ¸²æŸ“ç«™ç‚¹æ¡†æ¶
    const lineStations = stationCache[lineId]; 
    if (!lineStations || lineStations.length === 0) {
        panel.innerHTML = `<div style="padding:10px; color:var(--muted)">${STATUS_MAP_ZH["Stations Failed"]}</div>`;
        return;
    }

    renderStations(lineStations, panel); 

    // 3. é‡ç½®å¹¶å¯åŠ¨ä¸²è¡Œè¯·æ±‚é˜Ÿåˆ—
    // é˜Ÿåˆ—å·²åœ¨ loadStationArrivals ä¸­ç®¡ç†
  }

  /* -------------------------------
     4. æ¸²æŸ“ç«™ç‚¹åˆ—è¡¨
  ------------------------------- */
  function renderStations(stations, panel) {
    panel.innerHTML = ""; // æ¸…ç©ºåŠ è½½æç¤º
    arrivalQueue = Promise.resolve(); // é‡ç½®é˜Ÿåˆ—

    stations.forEach(stop => {
      const row = document.createElement("div");
      row.className = "station-row";

      // ç«™ç‚¹ ID æ˜¯ stop.idï¼Œåç§°æ˜¯ stop.commonName
      row.innerHTML = `
        <div class="station-name">${stop.commonName}</div>
        <div class="station-next" data-id="${stop.id}">
          <span class="muted">${STATUS_MAP_ZH["Loading..."]}</span>
        </div>
      `;

      panel.appendChild(row);

      /* è·å–æ¯ä¸ªç«™ç‚¹çš„åˆ°ç«™é¢„æµ‹ï¼ˆèŠ‚æµ/ä¸²è¡Œï¼‰ */
      loadStationArrivals(stop.id, row.querySelector(".station-next"));
    });
  }

  /* -------------------------------
      è·å–æŸç«™ç‚¹åˆ°ç«™é¢„æµ‹ (ä¸²è¡Œ)
  ------------------------------- */
  function loadStationArrivals(stopId, el) {
    // å°†æ–°çš„è¯·æ±‚æ¨å…¥é˜Ÿåˆ—ï¼Œç¡®ä¿å‰ä¸€ä¸ªè¯·æ±‚å®Œæˆåæ‰å¼€å§‹
    arrivalQueue = arrivalQueue.then(async () => {
      // å¢åŠ å»¶è¿Ÿä»¥ç¡®ä¿ TfL ä¸ä¼šè§¦å‘ 429
      await new Promise(r => setTimeout(r, 100)); 

      try {
        const url = `${API_BASE}/StopPoint/${stopId}/Arrivals`;
        const res = await fetchTfL(url);

        if (!res.ok) throw new Error("API " + res.status);

        const trains = await res.json();

        if (trains.length === 0) {
          el.textContent = STATUS_MAP_ZH["Data Unav      display:flex;
      flex-direction:column;
      min-height:100vh;
      box-sizing:border-box;
    }

    /* Header */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding-bottom:12px;
      border-bottom:4px solid #dc2626; /* çº¢è‰²æ¡ï¼Œå‘¼åº” Roundel */
    }

    .brand {
      display:flex;
      align-items:center;
      gap:12px;
    }

    .title {
      font-weight:800;
      font-size:20px;
      letter-spacing:0.2px;
    }

    .subtitle {
      font-size:13px;
      color:var(--muted);
      margin-top:2px;
    }

    /* Roundel containerï¼ˆå³ä¾§ï¼‰ */
    .roundel-wrap{
      display:flex;
      align-items:center;
      gap:12px;
    }

    /* Roundel SVG */
    .roundel {
      width:64px;
      height:64px;
      position:relative;
      flex-shrink:0;
    }

    /* å†…éƒ¨è“è‰²æ¡çš„æ–‡å­—è½®æ¢ */
    .roundel .band {
      position:absolute;
      left:0;
      right:0;
      top:50%;
      transform:translateY(-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      height:22px;
      overflow:hidden;
    }

    .roundel .band .word {
      display:block;
      height:22px;
      line-height:22px;
      font-weight:500;
      color:white;
      padding:0 10px;
      white-space:nowrap;
      animation: slideWords 12s linear infinite;
     
    }

    /* æ¯ä¸ª word å‘ä¸Šæ»šåŠ¨ï¼Œå…³é”®å¸§å¤„ç†ä¸º 6 ä¸ªè¯çš„å¾ªç¯ï¼ˆç­‰åˆ†ï¼‰ */
    @keyframes slideWords {
      0% { transform: translateY(0); }
      16.66% { transform: translateY(-22px); }
      33.33% { transform: translateY(-44px); }
      50% { transform: translateY(-66px); }
      66.66% { transform: translateY(-88px); }
      83.33% { transform: translateY(-110px); }
      100% { transform: translateY(0); }
    }

    /* ä¸»ä½“ï¼ˆçŠ¶æ€åˆ—è¡¨åŒºåŸŸï¼‰ */
    main {
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:14px;
      padding-top:18px;
      padding-bottom:18px;
      overflow:visible;
    }

    #status-container{
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
      padding-right:6px;
    }

    /* å¡ç‰‡æ ·å¼ */
    .line-card{
      display:flex;
      flex-direction:column;
      background:var(--card);
      border-radius:10px;
      padding:12px;
      box-shadow:0 6px 18px rgba(15,23,42,0.06);
      border-left:8px solid #333;
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .line-card:hover{ transform: translateY(-3px); box-shadow:0 12px 30px rgba(15,23,42,0.08); }

    .line-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .line-title{
      font-weight:700;
      font-size:16px;
    }

    .status-chip{
      font-weight:700;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      white-space:nowrap;
    }

    .status-good{ background:#d1fae5; color:#065f46; }
    .status-minor{ background:#fff7ed; color:#92400e; }
    .status-severe{ background:#fee2e2; color:#991b1b; }

    .line-reason{
      margin-top:8px;
      color:#374151;
      font-size:13px;
    }

    /* ç«™ç‚¹å±•å¼€é¢æ¿ */
    .stations-panel{
      margin-top:10px;
      border-radius:8px;
      overflow:hidden;
      border:1px dashed rgba(0,0,0,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(250,250,250,0.96));
      padding:8px;
    }

    .station-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px;
      border-bottom:1px solid rgba(15,23,42,0.03);
    }
    .station-row:last-child{ border-bottom:0; }

    .station-name{ font-weight:600; color:#0f172a; }
    .station-next{ font-size:13px; color:#374151; text-align:right; min-width:160px; }

    /* Footer */
    footer{
      margin-top:12px;
      padding-top:10px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }

    /* Loading / Error */
    .loading {
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      padding:18px;
      color:var(--muted);
    }

    .spinner {
      width:28px; height:28px;
      border-radius:50%;
      border:3px solid rgba(0,0,0,0.08);
      border-left-color:var(--tfl-red);
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-box {
      background:#fef2f2;
      color:#991b1b;
      padding:10px;
      border-radius:8px;
      font-weight:600;
    }

    /* Responsive */
    @media (max-width:640px){
      .roundel { width:52px; height:52px; }
      .line-title{ font-size:15px; }
      .station-next{ min-width:120px; font-size:12px; }
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark){
      :root{
        --bg: #0b1220;
        --card: #0f1724;
        --muted: #9ca3af;
      }
      body{ background: var(--bg); color:#e6eef8;}
      header{ border-bottom-color:#dc2626;}
      .line-card{ background: linear-gradient(180deg,#0b1224,#0c1528); box-shadow: 0 6px 20px rgba(2,6,23,0.6);}
      .line-reason{ color:#cbd5e1;}
      .stations-panel{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.03);}
    }

    /* Line color utility classes (left border) */
    .border-bakerloo { border-left-color: #B36305; }
    .border-central { border-left-color: #E32017; }
    .border-circle { border-left-color: #FFD300; }
    .border-district { border-left-color: #00782A; }
    .border-hammersmith-city { border-left-color: #F3A9A2; }
    .border-jubilee { border-left-color: #A0A5A9; }
    .border-metropolitan { border-left-color: #9B0056; }
    .border-northern { border-left-color: #000000; }
    .border-piccadilly { border-left-color: #003688; }
    .border-victoria { border-left-color: #0098D4; }
    .border-waterloo-city { border-left-color: #99D1C9; }
    .border-elizabeth { border-left-color: #6950a1; }
    .border-london-overground { border-left-color: #EE7D3A; }

    .tag-og {
      background: #EE7D3A;   /* Overground æ©™è‰² */
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      margin-left: 6px;
      border-radius: 4px;
    }

    .tag-nr {
      background: #D40000;   /* National Rail çº¢è‰² */
      color: white;
      font-size: 11px;
      padding: 2px 6px;
      margin-left: 6px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="app-container">
    <header>
      <div class="brand">
        <div>
          <div class="title">Mind the Tube</div>
          <div class="subtitle">Live London Underground Status</div>
        </div>
      </div>

      <div class="roundel-wrap" aria-hidden="true">
        <div class="roundel" role="img" aria-label="London Underground">
          <svg viewBox="0 0 100 100" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet" style="display:block;">
            <circle cx="50" cy="50" r="36" stroke="#e60028" stroke-width="12" fill="white"></circle>
            <rect x="6" y="40" width="88" height="20" rx="3" ry="3" fill="#0019A8"></rect>
          </svg>
          <div class="band" style="left:6px; right:6px;">
            <div class="word">UNDERGROUND</div>
            <div class="word">KING'S CROSS</div>
            <div class="word">PADDINGTON</div>
            <div class="word">PICCADILLY CIRCUS</div>
            <div class="word">WATERLOO</div>
            <div class="word">OXFORD CIRCUS</div>
          </div>
        </div>
      </div>
    </header>

    <main>
      <section id="status-container" aria-live="polite">
        <div id="loading" class="loading">
          <div class="spinner" aria-hidden="true"></div>
          <div>Fetching live status from TfL...</div>
        </div>

        <div id="error" class="error-box" style="display:none;"></div>

        </section>
    </main>

    <footer>
      å¼€æ”¾æ•°æ®æ¥æºäºä¼¦æ•¦äº¤é€šå±€ï¼ˆTfLï¼‰ Â· æˆ‘ä»¬ä¸TfLæ²¡æœ‰ä»å±å…³ç³»
      <div style="margin-top:6px; font-size:12px; color:var(--muted)">Last updated: <span id="last-updated">--:--</span></div>
    </footer>
  </div>

<script>
/* -----------------------------------------------------
   TfL å®æ—¶çº¿è·¯ + ç«™ç‚¹åˆ°ç«™ä¿¡æ¯ä¸»ç¨‹åº (ä¼˜åŒ–ç‰ˆ)
   è§£å†³ 429 é”™è¯¯çš„é€»è¾‘ï¼šæ¯æ¬¡ç‚¹å‡»åªå‘2ä¸ªè¯·æ±‚
----------------------------------------------------- */

document.addEventListener("DOMContentLoaded", () => {

  const API_BASE = "https://api.tfl.gov.uk";
  const statusContainer = document.getElementById("status-container");
  const loadingBox = document.getElementById("loading");
  const errorBox = document.getElementById("error");
  const lastUpdated = document.getElementById("last-updated");

  // æœ¬åœ°ç¼“å­˜ï¼šç”¨äºå­˜å‚¨å„æ¡çº¿è·¯çš„ç«™ç‚¹åˆ—è¡¨ï¼Œé¿å…é‡å¤è¯·æ±‚é™æ€æ•°æ®
  const stationCache = {};

  const LINE_COLORS = {
    bakerloo: "#B36305",
    central: "#E32017",
    circle: "#FFD300",
    district: "#00782A",
    "hammersmith-city": "#F3A9A2",
    jubilee: "#A0A5A9",
    metropolitan: "#9B0056",
    northern: "#000000",
    piccadilly: "#003688",
    victoria: "#0098D4",
    "waterloo-city": "#99D1C9",
    elizabeth: "#6950a1",
    "london-overground": "#EE7D3A"
  };
  
  const LINE_NAMES_ZH = {
    "bakerloo": "è´å…‹å¢çº¿",
    "central": "ä¸­å¤®çº¿",
    "circle": "ç¯çº¿",
    "district": "åŒºåŸŸçº¿",
    "hammersmith-city": "å“ˆé»˜å²å¯†æ–¯åŠåŸå¸‚çº¿",
    "jubilee": "é“¶ç¦§çº¿",
    "metropolitan": "å¤§éƒ½ä¼šçº¿",
    "northern": "åŒ—çº¿",
    "piccadilly": "çš®å¡è¿ªåˆ©çº¿",
    "victoria": "ç»´å¤šåˆ©äºšçº¿",
    "waterloo-city": "æ»‘é“å¢åŠåŸå¸‚çº¿",
    "elizabeth": "ä¼Šä¸½èç™½çº¿",
    "london-overground": "ä¼¦æ•¦åœ°ä¸Šé“"
  };

  /* çŠ¶æ€ â†’ Chip é¢œè‰²åˆ†ç±» */
  function severityToClass(severity) {
    if (!severity) return "status-good";
    severity = severity.toLowerCase();

    if (severity.includes("good")) return "status-good";
    if (severity.includes("minor")) return "status-minor";
    if (severity.includes("severe") || severity.includes("suspended")) return "status-severe";

    return "status-minor";
  }

  /* ---------------------------
      ä¸»è¯·æ±‚ï¼šè·å–æ‰€æœ‰çº¿è·¯çŠ¶æ€
  --------------------------- */
  async function loadLineStatus() {
    try {
      loadingBox.style.display = "flex";
      errorBox.style.display = "none";

      const url = `${API_BASE}/Line/Mode/tube,overground,elizabeth-line/Status`;
      const res = await fetch(url, { cache: "no-cache" });

      if (!res.ok) throw new Error("TfL API returned " + res.status);

      const lines = await res.json();
      renderLineCards(lines);

      loadingBox.style.display = "none";
      lastUpdated.textContent = new Date().toLocaleTimeString();

    } catch (err) {
      loadingBox.style.display = "none";
      errorBox.textContent = "Error fetching line status: " + err.message;
      errorBox.style.display = "block";
    }
  }

  /* ---------------------------
     æ¸²æŸ“çº¿è·¯å¡ç‰‡
  --------------------------- */
  function renderLineCards(lines) {
    /* æ¸…ç©ºæ—§å¡ç‰‡ï¼Œæ³¨æ„ä¸è¦æ¸…é™¤å±•å¼€çŠ¶æ€æœ€å¥½çš„åšæ³•æ˜¯å…¨é‡ç»˜æˆ–Diffï¼Œ
       è¿™é‡Œä¸ºäº†ç®€å•ç›´æ¥é‡ç»˜ï¼Œä½†ä½“éªŒä¸Šä¼šæŠ˜å å·²æ‰“å¼€çš„å¡ç‰‡ã€‚
       (æ ¹æ®éœ€æ±‚åªä¿ç•™æœ€åŸºç¡€åŠŸèƒ½) */
    const oldCards = statusContainer.querySelectorAll(".line-card");
    oldCards.forEach(x => x.remove());

    lines.forEach(line => {
      const id = line.id;
      const name = LINE_NAMES_ZH[id] || line.name;
      const status = line.lineStatuses?.[0]?.statusSeverityDescription ?? "Unknown";
      const reason = line.lineStatuses?.[0]?.reason ?? "";

      const color = LINE_COLORS[id] || "#333";
      const severityClass = severityToClass(status);

      /* åˆ›å»ºå¡ç‰‡ */
      const card = document.createElement("div");
      card.className = `line-card border-${id}`;
      card.style.borderLeftColor = color;

      card.innerHTML = `
        <div class="line-head">
          <div class="line-title">
            ${name}
            ${id === "london-overground" ? "<span class='tag-og'>OG</span>" : ""}
            ${id === "national-rail" ? "<span class='tag-nr'>NR</span>" : ""}
          </div>
          <div class="status-chip ${severityClass}">${status}</div>
        </div>
        ${reason ? `<div class="line-reason">${reason}</div>` : ""}
      `;

      /* ç‚¹å‡»å±•å¼€ç«™ç‚¹ */
      card.addEventListener("click", () => toggleStations(id, card));

      statusContainer.appendChild(card);
    });
  }

  /* ---------------------------------------------------
     ç‚¹å‡»çº¿è·¯ â†’ ä¼˜åŒ–åçš„åŠ è½½é€»è¾‘ (2æ¬¡è¯·æ±‚æå®šå…¨çº¿)
  --------------------------------------------------- */
  async function toggleStations(lineId, cardEl) {
    const existing = cardEl.querySelector(".stations-panel");

    // å¦‚æœå·²ç»æ‰“å¼€ â†’ æŠ˜å 
    if (existing) {
      existing.remove();
      return;
    }

    // æ˜¾ç¤ºåŠ è½½æç¤º
    const panel = document.createElement("div");
    panel.className = "stations-panel";
    panel.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        <div>Fetching live trains...</div>
      </div>
    `;
    cardEl.appendChild(panel);

    try {
      /* å¹¶è¡Œè¯·æ±‚ï¼š
         1. ç«™ç‚¹åˆ—è¡¨ (å¦‚æœç¼“å­˜æ²¡æœ‰)
         2. å…¨çº¿åˆ°ç«™é¢„æµ‹ (Arrivals)
         è¿™æ ·ä¸€æ¬¡ç‚¹å‡»æœ€å¤šæ¶ˆè€— 2 ä¸ª API è¯·æ±‚ï¼Œå¤§å¹…é™ä½ 429 é£é™©ã€‚
      */
      const promises = [];

      // Task 1: ç«™ç‚¹åˆ—è¡¨
      if (stationCache[lineId]) {
        promises.push(Promise.resolve(stationCache[lineId]));
      } else {
        promises.push(
          fetch(`${API_BASE}/Line/${lineId}/StopPoints`)
            .then(r => r.json())
            .then(data => {
              // ç®€å•è¿‡æ»¤ï¼Œç¡®ä¿æ˜¯è½¦ç«™
              const valid = data.filter(d => d.commonName);
              stationCache[lineId] = valid;
              return valid;
            })
        );
      }

      // Task 2: å…¨çº¿åˆ°ç«™æ•°æ®
      promises.push(
        fetch(`${API_BASE}/Line/${lineId}/Arrivals`, { cache: "no-cache" })
          .then(r => r.json())
      );

      const [stations, arrivals] = await Promise.all(promises);

      /* æ¸²æŸ“ç«™ç‚¹ + åŒ¹é…æ•°æ® */
      renderStations(stations, arrivals, panel);

    } catch (err) {
      console.error(err);
      panel.innerHTML = `<div class="error-box">Error loading data: ${err.message}</div>`;
    }
  }

/* -------------------------------
     æ¸²æŸ“ç«™ç‚¹ + å†…å­˜åŒ¹é…åˆ°ç«™æ•°æ® (å·²ä¿®å¤ replace é”™è¯¯)
------------------------------- */
function renderStations(stations, allArrivals, panel) {
  panel.innerHTML = "";

  // 1. å°†åˆ°ç«™æ•°æ®æŒ‰ naptanId åˆ†ç»„ï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾
  const arrivalMap = {};
  allArrivals.forEach(train => {
    const sId = train.naptanId;
    if (!arrivalMap[sId]) arrivalMap[sId] = [];
    arrivalMap[sId].push(train);
  });

  // 2. éå†æ‰€æœ‰ç«™ç‚¹å¹¶æ¸²æŸ“
  const validStations = stations.filter(s => 
    s.stopType === "NaptanMetroStation" || 
    s.stopType === "NaptanRailStation" ||
    s.modes.includes("tube") || 
    s.modes.includes("elizabeth-line") ||
    s.modes.includes("overground")
  );

  if (validStations.length === 0) {
    panel.innerHTML = `<div style="padding:10px; color:var(--muted)">No stations found.</div>`;
    return;
  }

  validStations.forEach(stop => {
    const row = document.createElement("div");
    row.className = "station-row";

    // è·å–è¯¥ç«™ç‚¹çš„åˆ—è½¦åˆ—è¡¨
    const trains = arrivalMap[stop.id] || [];
    
    // æŒ‰æ—¶é—´æ’åº
    trains.sort((a, b) => a.timeToStation - b.timeToStation);

    // æ„å»ºå³ä¾§çŠ¶æ€ HTML
    let statusHtml = "<span style='color:#9ca3af'>--</span>";

    if (trains.length > 0) {
      const next = trains[0];
      const mins = Math.round(next.timeToStation / 60);
      const timeStr = mins < 1 ? "Due" : `${mins} min`;
      
      // ã€ä¿®å¤ç‚¹ã€‘ï¼šä½¿ç”¨ ?? "" ç¡®ä¿ destinationName å±æ€§å­˜åœ¨ä¸”ä¸ºå­—ç¬¦ä¸²
      const rawDestName = next.destinationName ?? ""; 
      
      // å»æ‰å†—ä½™åç¼€
      const dest = rawDestName.replace(" Underground Station", "").replace(" Rail Station", "");

      statusHtml = `
        <div style="font-weight:700; color:var(--tfl-blue)">${timeStr}</div>
        <div style="font-size:11px; color:var(--muted)">${dest}</div>
      `;
    }

    row.innerHTML = `
      <div class="station-name">${stop.commonName}</div>
      <div class="station-next">${statusHtml}</div>
    `;

    panel.appendChild(row);
  });
}


  /* 60 ç§’åˆ·æ–°ä¸€æ¬¡çº¿è·¯çŠ¶æ€ */
  loadLineStatus();
  setInterval(loadLineStatus, 60000);

});
</script>

</body>
</html>

